rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // VALIDATION FUNCTIONS (No auth checks)
    // ========================================
    
    function isValidPlayerName(name) {
      return name is string 
        && name.size() >= 2 
        && name.size() <= 50;
    }
    
    function isValidRunTime(runTime) {
      return runTime is string 
        && runTime.matches('^([0-9]|[0-5][0-9]):([0-5][0-9])$');
    }
    
    function isValidBroadJump(value) {
      return value is number 
        && value >= 0 
        && value <= 500;
    }
    
    function isValidSprint(value) {
      return value is number 
        && value >= 0 
        && value <= 60;
    }
    
    function isValidMatrixExercise(value) {
      return value is number 
        && value >= 0 
        && value <= 100;
    }
    
    function isCoach() {
      return request.auth != null 
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'coach';
    }
    
    // ========================================
// USERS COLLECTION
// ========================================
match /users/{userId} {
  // Allow users to read their own document, coaches can read all
  allow read: if request.auth != null 
    && (request.auth.uid == userId || isCoach());
  
  // Allow users to get their own document even during initialization
  allow get: if request.auth != null 
    && request.auth.uid == userId;
      
      allow create: if request.auth != null
        && request.auth.uid == userId
        && request.resource.data.uid == userId
        && request.resource.data.role in ['player', 'coach']
        && request.resource.data.email is string
        && request.resource.data.displayName is string;
      
      allow update: if request.auth != null
        && (
          (request.auth.uid == userId
           && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastLogin']))
          || (isCoach()
              && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['playerId', 'linkedAt']))
        );
    }
    
    // ========================================
    // PLAYERS COLLECTION
    // ========================================
    match /players/{playerId} {
      allow read: if request.auth != null;
      
      allow create: if request.auth != null
        && isValidPlayerName(request.resource.data.name)
        && request.resource.data.createdAt == request.time
        && (
          request.resource.data.userId == request.auth.uid
          || !request.resource.data.keys().hasAny(['userId'])
          || request.resource.data.userId == null
        );
      
      allow update: if request.auth != null
        && isCoach()
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['name', 'userId', 'linkedAt']);
      
      allow delete: if request.auth != null && isCoach();
    }
    
    // ========================================
    // TRAINING SESSIONS COLLECTION - UPDATED
    // ========================================
    match /training_sessions/{sessionId} {
      allow read: if request.auth != null;
      
      allow create: if request.auth != null
        && request.resource.data.keys().hasAll([
          'playerId', 
          'playerName', 
          'date', 
          'runTime',
          'broadJumps',
          'sprints',
          'createdAt'
        ])
        && request.resource.data.playerId is string
        && request.resource.data.playerName is string
        && request.resource.data.date is string
        && (request.resource.data.runTime == '' || isValidRunTime(request.resource.data.runTime))
        && request.resource.data.broadJumps.keys().hasAll([
          'leftSingle', 
          'rightSingle', 
          'doubleSingle',
          'leftTriple',
          'rightTriple',
          'doubleTriple'
        ])
        && isValidBroadJump(request.resource.data.broadJumps.leftSingle)
        && isValidBroadJump(request.resource.data.broadJumps.rightSingle)
        && isValidBroadJump(request.resource.data.broadJumps.doubleSingle)
        && isValidBroadJump(request.resource.data.broadJumps.leftTriple)
        && isValidBroadJump(request.resource.data.broadJumps.rightTriple)
        && isValidBroadJump(request.resource.data.broadJumps.doubleTriple)
        && request.resource.data.sprints is list
        && request.resource.data.sprints.size() == 6
        && isValidSprint(request.resource.data.sprints[0])
        && isValidSprint(request.resource.data.sprints[1])
        && isValidSprint(request.resource.data.sprints[2])
        && isValidSprint(request.resource.data.sprints[3])
        && isValidSprint(request.resource.data.sprints[4])
        && isValidSprint(request.resource.data.sprints[5])
        && request.resource.data.createdAt == request.time;
      
      // ✅ NEW: Allow coaches to update sessions
      allow update: if request.auth != null 
        && isCoach()
        && request.resource.data.playerId == resource.data.playerId
        && request.resource.data.keys().hasAll([
          'playerId', 
          'playerName', 
          'date', 
          'runTime',
          'broadJumps',
          'sprints',
          'createdAt'
        ])
        && (request.resource.data.runTime == '' || isValidRunTime(request.resource.data.runTime))
        && isValidBroadJump(request.resource.data.broadJumps.leftSingle)
        && isValidBroadJump(request.resource.data.broadJumps.rightSingle)
        && isValidBroadJump(request.resource.data.broadJumps.doubleSingle)
        && isValidBroadJump(request.resource.data.broadJumps.leftTriple)
        && isValidBroadJump(request.resource.data.broadJumps.rightTriple)
        && isValidBroadJump(request.resource.data.broadJumps.doubleTriple)
        && request.resource.data.sprints.size() == 6
        && isValidSprint(request.resource.data.sprints[0])
        && isValidSprint(request.resource.data.sprints[1])
        && isValidSprint(request.resource.data.sprints[2])
        && isValidSprint(request.resource.data.sprints[3])
        && isValidSprint(request.resource.data.sprints[4])
        && isValidSprint(request.resource.data.sprints[5]);
      
      // ✅ NEW: Allow coaches to delete sessions
      allow delete: if request.auth != null && isCoach();
    }
    
    // ========================================
    // MATRIX SESSIONS COLLECTION - UPDATED
    // ========================================
    // MATRIX SESSIONS COLLECTION - UPDATED
match /matrix_sessions/{sessionId} {
  allow read: if request.auth != null;
  
  allow create: if request.auth != null
    && request.resource.data.keys().hasAll([
      'playerId', 
      'playerName', 
      'date',
      'exercises',
      'createdAt'
    ])
    && request.resource.data.playerId is string
    && request.resource.data.playerName is string
    && request.resource.data.date is string
    && request.resource.data.exercises is map
    && request.resource.data.exercises.keys().hasAll([
      'volleyFigure8',
      'bounceFigure8',
      'volleySideToSide',
      'bounceSideToSide',  // ✅ ADD THIS
      'dropTargetBackhand',
      'dropTargetForehand',
      'serviceBoxDriveForehand',
      'serviceBoxDriveBackhand',
      'cornerVolleys',
      'beepTest',
      'ballTransfer',
      'slalom'
    ])
    && isValidMatrixExercise(request.resource.data.exercises.volleyFigure8)
    && isValidMatrixExercise(request.resource.data.exercises.bounceFigure8)
    && isValidMatrixExercise(request.resource.data.exercises.volleySideToSide)
    && isValidMatrixExercise(request.resource.data.exercises.bounceSideToSide)  // ✅ ADD THIS
    && isValidMatrixExercise(request.resource.data.exercises.dropTargetBackhand)
    && isValidMatrixExercise(request.resource.data.exercises.dropTargetForehand)
    && isValidMatrixExercise(request.resource.data.exercises.serviceBoxDriveForehand)
    && isValidMatrixExercise(request.resource.data.exercises.serviceBoxDriveBackhand)
    && isValidMatrixExercise(request.resource.data.exercises.cornerVolleys)
    && isValidMatrixExercise(request.resource.data.exercises.beepTest)
    && isValidMatrixExercise(request.resource.data.exercises.ballTransfer)
    && isValidMatrixExercise(request.resource.data.exercises.slalom)
    && request.resource.data.createdAt == request.time;
  
  // ✅ UPDATE: Allow coaches to update matrix sessions
  allow update: if request.auth != null 
    && isCoach()
    && request.resource.data.playerId == resource.data.playerId
    && request.resource.data.keys().hasAll([
      'playerId', 
      'playerName', 
      'date',
      'exercises',
      'createdAt'
    ])
    && isValidMatrixExercise(request.resource.data.exercises.volleyFigure8)
    && isValidMatrixExercise(request.resource.data.exercises.bounceFigure8)
    && isValidMatrixExercise(request.resource.data.exercises.volleySideToSide)
    && isValidMatrixExercise(request.resource.data.exercises.bounceSideToSide)  // ✅ ADD THIS
    && isValidMatrixExercise(request.resource.data.exercises.dropTargetBackhand)
    && isValidMatrixExercise(request.resource.data.exercises.dropTargetForehand)
    && isValidMatrixExercise(request.resource.data.exercises.serviceBoxDriveForehand)
    && isValidMatrixExercise(request.resource.data.exercises.serviceBoxDriveBackhand)
    && isValidMatrixExercise(request.resource.data.exercises.cornerVolleys)
    && isValidMatrixExercise(request.resource.data.exercises.beepTest)
    && isValidMatrixExercise(request.resource.data.exercises.ballTransfer)
    && isValidMatrixExercise(request.resource.data.exercises.slalom);
  
  allow delete: if request.auth != null && isCoach();
}
  }
}