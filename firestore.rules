rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // VALIDATION FUNCTIONS (No auth checks)
    // ========================================
    
    function isValidPlayerName(name) {
      return name is string 
        && name.size() >= 2 
        && name.size() <= 50;
    }
    
    function isValidRunTime(runTime) {
      return runTime is string 
        && runTime.matches('^([0-9]|[0-5][0-9]):([0-5][0-9])$');
    }
    
    function isValidBroadJump(value) {
      return value is number 
        && value >= 0 
        && value <= 500;
    }
    
    function isValidSprint(value) {
      return value is number 
        && value >= 0 
        && value <= 60;
    }
    
    // ========================================
    // USERS COLLECTION
    // ========================================
    match /users/{userId} {
      // Anyone can read their own user document
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Anyone authenticated can create their own user document during registration
      allow create: if request.auth != null
        && request.auth.uid == userId
        && request.resource.data.uid == userId
        && request.resource.data.role in ['player', 'coach']
        && request.resource.data.email is string
        && request.resource.data.displayName is string;
      
      // Users can update their own lastLogin timestamp
      allow update: if request.auth != null
        && request.auth.uid == userId
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastLogin']);
    }
    
    // ========================================
    // PLAYERS COLLECTION
    // ========================================
    match /players/{playerId} {
      // Anyone authenticated can read all players
      // (Needed for: coach to see all players, player to see themselves in dropdowns)
      allow read: if request.auth != null;
      
      // Anyone authenticated can create a player with their own userId
      allow create: if request.auth != null
        && isValidPlayerName(request.resource.data.name)
        && request.resource.data.createdAt == request.time
        && (
          // Either: Player creating their own record
          request.resource.data.userId == request.auth.uid
          // Or: Coach creating a player (no userId or null userId)
          || !request.resource.data.keys().hasAny(['userId'])
          || request.resource.data.userId == null
        );
      
      // Anyone can update player names (we'll rely on app-level security)
      allow update: if request.auth != null
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['name']);
    }
    
    // ========================================
    // TRAINING SESSIONS COLLECTION
    // ========================================
    match /training_sessions/{sessionId} {
      // Anyone authenticated can read all sessions
      // (App code will filter by role - coach sees all, player sees only theirs)
      allow read: if request.auth != null;
      
      // Anyone authenticated can create a session
      // (App code enforces that coaches create for any player, players only for themselves)
      allow create: if request.auth != null
        && request.resource.data.keys().hasAll([
          'playerId', 
          'playerName', 
          'date', 
          'runTime',
          'broadJumps',
          'sprints',
          'createdAt'
        ])
        && request.resource.data.playerId is string
        && request.resource.data.playerName is string
        && request.resource.data.date is string
        && (request.resource.data.runTime == '' || isValidRunTime(request.resource.data.runTime))
        && request.resource.data.broadJumps.keys().hasAll([
          'leftSingle', 
          'rightSingle', 
          'doubleSingle',
          'leftTriple',
          'rightTriple',
          'doubleTriple'
        ])
        && isValidBroadJump(request.resource.data.broadJumps.leftSingle)
        && isValidBroadJump(request.resource.data.broadJumps.rightSingle)
        && isValidBroadJump(request.resource.data.broadJumps.doubleSingle)
        && isValidBroadJump(request.resource.data.broadJumps.leftTriple)
        && isValidBroadJump(request.resource.data.broadJumps.rightTriple)
        && isValidBroadJump(request.resource.data.broadJumps.doubleTriple)
        && request.resource.data.sprints is list
        && request.resource.data.sprints.size() == 6
        && isValidSprint(request.resource.data.sprints[0])
        && isValidSprint(request.resource.data.sprints[1])
        && isValidSprint(request.resource.data.sprints[2])
        && isValidSprint(request.resource.data.sprints[3])
        && isValidSprint(request.resource.data.sprints[4])
        && isValidSprint(request.resource.data.sprints[5])
        && request.resource.data.createdAt == request.time;
      
      // No updates or deletes
      allow update, delete: if false;
    }
  }
}